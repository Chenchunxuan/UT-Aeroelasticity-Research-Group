function caldata = fCalProc(directory)
% READ CALIBRATION FILES AND PLOT EACH FFT
% sirohi 200227
% MODIFIED CMJOHNSON 05/15/2020
%
% INPUTS
%     testdate          -> format: % "testdate"_test_"testletter"_cal"calsuffix" - 01 Start - 1.wav
%     calletter
%     calsuffix
% OUTPUTS
%     caldata
%         .fvec
%         .fs
%         .wavdata
%         .tvec
%         .calmag
%         .scale
%

pdir = pwd;
cd(directory); 
fprintf('\n%s\n',['Calibrating microphones. Calibration file: '])

%% INPUTS
files = dir('*.wav');
filenames = {files(:).name}';
dates = unique(extractBefore(filenames,'_'));
calletters = unique(extractBetween(filenames(contains(filenames,'cal')),'test_','_cal'));

fprintf('\n\t%s\n', ['Loaded test dates are [YYMMDD] : ' dates{:}]);

testdate = input(['\t Test Date [YYMMDD] : ', 's');

fprintf('\n%s', 'Loaded calibration tests are : ');
fprintf('%s , ', calletters{:});
calletter = input('\nCalibration test : ', 's');

if sum(contains(filenames,[calletter,'_cal'])) > 17 %more than one set of calibration files
    calsuffix = input('\nCalibration test suffix : ', 's');
else
    calsuffix = '';
end

calprefix = [testdate '_test_' calletter '_cal' calsuffix ' - 01 Start - '];
% calprefix = ['./Uber Acoustics ' testdate '/Audio Files/' testdate '_test_' testletter '_cal' calsuffix ' - 01 Start - '];
caldata = struct('scale', [], 'calmag', [], 'tvec',[],'wavdata',[],'fs',[],'fvec',[]);
cal_db = 114;

%% read the calibration files
fprintf('\n%s\n',['Calibrating microphones. Calibration file: ', testdate '_test_' calletter '_cal' calsuffix])
worv = input('Visualize (v) calibration data ? ', 's');
for micnum = 1:16
    fname = [calprefix num2str(micnum) '.wav'];
    if isfile(fname)
        fprintf('\t%s',['- Mic ', num2str(micnum),' ... '])
        [caldata(micnum).wavdata, caldata(micnum).fs] = audioread(fname);
        caldata(micnum).tvec = 0: 1/caldata(micnum).fs: (length(caldata(micnum).wavdata)-1)/caldata(micnum).fs;
        
        %[caldata(micnum).fvec, caldata(micnum).calmag, ~, ~] = ffind_dft(caldata(micnum).tvec, caldata(micnum).wavdata, 0);
        fs = 48000;
        NFFT = 32768;
        Nav = 31;
        win = 'hann';
        [caldata(micnum).fvec, caldata(micnum).calmag, ~] = ffind_spectrum(fs, caldata(micnum).wavdata, NFFT, Nav, win);
        
        %ASSUMING PERFECT SIN WAV
        %caldata(micnum).scale = max(caldata(micnum).calmag);
        
        %ASSUMING IMPERFECT SIN WAV
        caldata(micnum).scale = sqrt(sum(caldata(micnum).wavdata.^2)/length(caldata(micnum).wavdata));   
        caldata(micnum).calfactor = CalFactor(caldata, cal_db,micnum);

        %CHECK CALIBRATION
        OASPL = fOverallSPL_freq(caldata(micnum).calfactor * caldata(micnum).calmag);
        fprintf('%s\n',['OASPL = ',num2str(OASPL)])
        
        switch worv
            case 'v'
                subplot(2,1,1)
                plot(caldata(micnum).tvec, caldata(micnum).wavdata);
                grid on; grid minor;
                xlabel('Time, s');
                ylabel('Magnitude');
                legend(['Mic. ' num2str(micnum)]);
                xlim([0,.01])
                
                subplot(2,1,2)
                set(gca,'xscale','log')
                set(gca,'yscale','log')
                loglog(caldata(micnum).fvec, caldata(micnum).calmag);
                grid on; grid minor;
                xlabel('Frequency, Hz');
                ylabel('Magnitude');
                legend(['Mic. ' num2str(micnum)]);
                pause
            otherwise
        end
    else
        fprint(['File ', fname,' not found\n'])
    end
end
close all
cd(pdir);
end



